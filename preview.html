<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon.js Editor Preview</title>
    
    <script src="./node_modules/es6-promise/dist/es6-promise.auto.js" type="text/javascript"></script>
    <script src="./node_modules/systemjs/dist/system.src.js" type="text/javascript"></script>

    <script src="./node_modules/socket.io-client/dist/socket.io.js" type="text/javascript"></script>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            touch-action: none;
            -ms-touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script type="text/javascript">
        System.config({
            paths: {
                "babylonjs": "./node_modules/babylonjs/babylon.max.js",
                "babylonjs-materials": "./node_modules/babylonjs-materials/babylonjs.materials.min.js",
                "cannonjs": "./node_modules/cannon/build/cannon.min.js",
                "spectorjs": "./node_modules/spectorjs/dist/spector.bundle.js",
            },
            packages: {
                "./.build/src/": {
                    defaultExtension: "js"
                },
                "./node_modules/babylonjs-loaders/": {
                    format: "cjs",
                    main: "babylonjs.loaders.js",
                    format: "global"
                },
                "./node_modules/babylonjs-materials/": {
                    format: "cjs",
                    main: "babylonjs.materials.js",
                    format: "global"
                },
                "./node_modules/babylonjs/dist/preview release/materialsLibrary/": {
                    format: "cjs",
                    main: "babylonjs.materials.js",
                    format: "global"
                }
            },
            meta: {
                "cannonjs": { format: "global" },
                "babylonjs": { scriptLoad: true, format: "global", exports: "BABYLON" },
                "babylonjs-gui": { exports: "babylonDependency.GUI" },
                "babylonjs-materials": { exports: "babylonDependency" }
            }
        });

        // Loads the Babylon.js Scenes
        var loadScene = function (sceneFile) {
            var engine = new BABYLON.Engine(document.getElementById('renderCanvas'));
            window.addEventListener("resize", function () {
                engine.resize();
            });

            // Load Extensions Manager and then all extensions
            var promises = [];
            var files = [
                "./.build/src/extensions/behavior/code.js",
                "./.build/src/extensions/spector/spector-debug.js",
                "./.build/src/extensions/post-process/post-processes.js",
                "./.build/src/extensions/material-creator/material-creator.js",
                "./.build/src/extensions/post-process-creator/post-process-creator.js"
            ];

            for (var i = 0; i < files.length; i++) {
                promises.push(System.import(files[i]));
            }

            Promise.all(promises).then(function () {
                // Import scene
                BABYLON.SceneLoader.Load('file:', sceneFile, engine, function (scene) {
                    System.import('./.build/src/extensions/extensions.js').then(function (extensions) {
                        // Apply
                        var readProject = function (project) {
                            BABYLON.Tools.ReadFile(project, function (data) {
                                extensions.default.ApplyExtensions(scene, JSON.parse(data).customMetadatas);

                                // Run scene
                                scene.executeWhenReady(function () {
                                    scene.activeCamera.attachControl(engine.getRenderingCanvas());
                                    engine.runRenderLoop(function () {
                                        scene.render();
                                    });
                                });
                            });
                        };

                        getFileByExtension(BABYLON.FilesInput.FilesToLoad, 'editorproject', function (project) {
                            readProject(project);
                        });
                    });
                });
            });
        };

        // Imports the tools
        var importTools = function (callback) {
            System.import('./.build/src/editor/tools/tools.js').then(function (tools) {
                callback(tools);
            });
        }

        // Returns the scene file
        var getFileByExtension = function (files, extension, callback) {
            if (opener) {
                switch (extension) {
                    case 'babylon': return callback(opener.editor.sceneFile);
                    case 'editorproject': return callback(opener.editor.projectFile);
                    default: throw new Error('Cannot get file with extension "' + extension, '"');
                }
            } else {
                importTools(function (tools) {
                    for (var thing in files) {
                        var file = tools.default.CreateFile(files[thing], thing);
                        if (tools.default.GetFileExtension(file.name) === extension) {
                            callback(file);
                            break;
                        }
                    }
                });
            }
        };

        // Load Babylon.js
        // Get scene file
        // Run sockets
        var promises = [];
        promises.push(System.import("babylonjs"));
        promises.push(System.import("cannonjs"));
        Promise.all(promises).then(function (e) {
            return System.import("babylonjs-materials").then(function () {
                if (opener) {
                    BABYLON.FilesInput.FilesToLoad = opener.BABYLON.FilesInput.FilesToLoad;
                }

                getFileByExtension(BABYLON.FilesInput.FilesToLoad, 'babylon', function (sceneFile) {
                    loadScene(sceneFile);
                });

                var socket = io('http://localhost:1337/client');
                socket.on('request-scene', (files) => {
                    // Import Editor tools
                    importTools(function (tools) {
                        for (var thing in files) {
                            var file = tools.default.CreateFile(files[thing], thing);
                            BABYLON.FilesInput.FilesToLoad[thing] = file;
                        }

                        getFileByExtension(files, 'babylon', function (sceneFile) {
                            loadScene(sceneFile);
                        });
                    });
                });
            });
        });
    </script>
</body>
</html>